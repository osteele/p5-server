#!/bin/sh

lint_log=$(mktemp)
test_log=$(mktemp)
build_log=$(mktemp)
cli_log=$(mktemp)

# Lint
if ! bun run lint --max-warnings=0 >"$lint_log" 2>&1; then
  cat "$lint_log"
  exit 1
fi

# Test
if ! bun run test >"$test_log" 2>&1; then
  cat "$test_log"
  exit 1
fi

# Build
if ! bun run build >"$build_log" 2>&1; then
  cat "$build_log"
  exit 1
fi

# Workspace CLI versions
for ws in p5-analysis p5-server; do
  if [ -f "$ws/package.json" ]; then
    if ! (cd "$ws" && bun run cli --version) >"$cli_log" 2>&1; then
      echo "CLI version check failed in $ws:"
      cat "$cli_log"
      exit 1
    fi
  fi
done

rm -f "$lint_log" "$test_log" "$build_log" "$cli_log"
